---
- name: Configure EKS Worker Nodes
  hosts: eks_nodes
  become: yes
  tasks:
    - name: Update system packages
      yum:
        name: "*"
        state: latest

    - name: Install required packages
      yum:
        name:
          - docker
          - aws-cli
          - jq
          - curl
          - wget
        state: present

    - name: Ensure Docker is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Configure Docker daemon
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            },
            "storage-driver": "overlay2"
          }
      notify: Restart Docker

    - name: Set system limits for containers
      copy:
        dest: /etc/security/limits.d/containers.conf
        content: |
          * soft nofile 65536
          * hard nofile 65536
          * soft nproc 65536
          * hard nproc 65536

    - name: Configure kernel parameters
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: "net.bridge.bridge-nf-call-iptables", value: "1" }
        - { name: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
        - { name: "net.ipv4.ip_forward", value: "1" }
        - { name: "vm.max_map_count", value: "262144" }

    - name: Install CloudWatch agent
      shell: |
        wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
        rpm -U amazon-cloudwatch-agent.rpm
      args:
        creates: /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent

    - name: Configure CloudWatch agent
      copy:
        dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
        content: |
          {
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/containers/*.log",
                      "log_group_name": "/eks/ecommerce-prod/containers",
                      "log_stream_name": "{hostname}",
                      "retention_in_days": 14
                    }
                  ]
                }
              }
            },
            "metrics": {
              "namespace": "EcommercePlatform",
              "metrics_collected": {
                "cpu": { "measurement": ["usage_active"], "metrics_collection_interval": 60 },
                "mem": { "measurement": ["used_percent"], "metrics_collection_interval": 60 },
                "disk": { "measurement": ["used_percent"], "metrics_collection_interval": 60 }
              }
            }
          }
      notify: Restart CloudWatch Agent

  handlers:
    - name: Restart Docker
      systemd:
        name: docker
        state: restarted

    - name: Restart CloudWatch Agent
      shell: /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a stop && /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a start
